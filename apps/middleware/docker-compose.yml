services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-termoflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-termoflow}
      POSTGRES_DB: ${POSTGRES_DB:-termoflow}
    volumes:
      - termoflow_postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB} -h 127.0.0.1"]
      interval: 10s
      timeout: 3s
      retries: 10

  termoflow-graphql-middleware:
    build: .
    restart: unless-stopped
    init: true
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    ports:
      - "4000:4000"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-4000}
      SERVICE_NAME: ${SERVICE_NAME:-termoflow-graphql-middleware}
      APP_VERSION: ${APP_VERSION:-}
      TRUST_PROXY: ${TRUST_PROXY:-}
      REQUEST_BODY_LIMIT: ${REQUEST_BODY_LIMIT:-1mb}
      CORS_ORIGINS: ${CORS_ORIGINS:-}
      API_KEY: ${API_KEY:-}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-120}
      ENABLE_INTROSPECTION: ${ENABLE_INTROSPECTION:-}
      MAX_OPERATIONS: ${MAX_OPERATIONS:-1}
      MAX_QUERY_DEPTH: ${MAX_QUERY_DEPTH:-10}
      MAX_QUERY_FIELDS: ${MAX_QUERY_FIELDS:-200}
      MAX_QUERY_LENGTH: ${MAX_QUERY_LENGTH:-10000}
      SERVER_KEEP_ALIVE_TIMEOUT_MS: ${SERVER_KEEP_ALIVE_TIMEOUT_MS:-5000}
      SERVER_HEADERS_TIMEOUT_MS: ${SERVER_HEADERS_TIMEOUT_MS:-10000}
      SERVER_REQUEST_TIMEOUT_MS: ${SERVER_REQUEST_TIMEOUT_MS:-30000}
      UPSTREAM_BASE_URL: ${UPSTREAM_BASE_URL:-}
      UPSTREAM_HEALTH_PATH: ${UPSTREAM_HEALTH_PATH:-/health}
      UPSTREAM_ALLOWED_PATH_PREFIXES: ${UPSTREAM_ALLOWED_PATH_PREFIXES:-}
      UPSTREAM_MAX_RESPONSE_BYTES: ${UPSTREAM_MAX_RESPONSE_BYTES:-2000000}
      UPSTREAM_TIMEOUT_MS: ${UPSTREAM_TIMEOUT_MS:-10000}
      DATABASE_URL: ${DATABASE_URL:-postgresql://termoflow:termoflow@postgres:5432/termoflow?schema=public}

volumes:
  termoflow_postgres:
